/*! dcmjs-dimse - 0.1.28 - 2024-07-19 | (c) 2021-2024 Pantelis Georgiadis | https://github.com/PantelisGeorgiadis/dcmjs-dimse */
!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("async-eventemitter"),require("dcmjs"),require("smart-buffer"),require("ts-mixer"),require("winston")):"function"==typeof define&&define.amd?define("dcmjs-dimse",["async-eventemitter","dcmjs","smart-buffer","ts-mixer","winston"],t):"object"==typeof exports?exports["dcmjs-dimse"]=t(require("async-eventemitter"),require("dcmjs"),require("smart-buffer"),require("ts-mixer"),require("winston")):e["dcmjs-dimse"]=t(e["async-eventemitter"],e.dcmjs,e["smart-buffer"],e["ts-mixer"],e.winston)}(global,((e,t,s,n,i)=>{return r={570:(e,t,s)=>{const{CGetRequest:n,CStoreRequest:i}=s(940),{CommandFieldType:r,PresentationContextResult:o,SopClass:a,StorageClass:c,TransferSyntax:d,Uid:u,UserIdentityType:h}=s(492),m=s(139),{EOL:g}=s(857);class l{constructor(e,t,s,n){this.pcId=e,this.abstractSyntaxUid=t,this.transferSyntaxes=[],s&&this.transferSyntaxes.push(s),this.result=n||o.Proposed}getPresentationContextId(){return this.pcId}getAbstractSyntaxUid(){return this.abstractSyntaxUid}getTransferSyntaxUids(){return this.transferSyntaxes}addTransferSyntaxUid(e){this.transferSyntaxes.includes(e)||this.transferSyntaxes.push(e)}removeTransferSyntaxUid(e){if(!this.transferSyntaxes.includes(e))return;const t=this.transferSyntaxes.indexOf(e);-1!==t&&this.transferSyntaxes.splice(t,1)}hasTransferSyntaxUid(e){return this.transferSyntaxes.includes(e)}getAcceptedTransferSyntaxUid(){return this.transferSyntaxes.length>0?this.transferSyntaxes[0]:void 0}getResult(){return this.result}setResult(e,t){this.result=e;const s=[...this.transferSyntaxes];this.transferSyntaxes.length=0,t?this.transferSyntaxes.push(t):s.length>0&&this.transferSyntaxes.push(s[0])}getResultDescription(){switch(this.result){case o.Accept:return"Accept";case o.Proposed:return"Proposed";case o.RejectAbstractSyntaxNotSupported:return"Reject - Abstract Syntax Not Supported";case o.RejectNoReason:return"Reject - No Reason";case o.RejectTransferSyntaxesNotSupported:return"Reject - Transfer Syntaxes Not Supported";case o.RejectUser:return"Reject - User";default:return"Unknown"}}toString(){const e=[];return e.push(`Presentation Context:  ${this.getPresentationContextId()} [${this.getResultDescription()}]`),e.push(`  Abstract:  ${this.getAbstractSyntaxUid()}`),this.getTransferSyntaxUids().forEach((t=>{e.push(`      Transfer:  ${t}`)})),e.join(g)}}e.exports={Association:class{constructor(e,t){this.callingAeTitle=e,this.calledAeTitle=t,this.maxPduLength=m.getMaxPduLength(),this.applicationContextName=u.ApplicationContextName,this.implementationClassUid=m.getImplementationClassUid(),this.implementationVersion=m.getImplementationVersion(),this.presentationContexts=[],this.negotiateAsyncOps=!1,this.maxAsyncOpsInvoked=1,this.maxAsyncOpsPerformed=1,this.negotiateUserIdentity=!1,this.userIdentityType=h.Username,this.userIdentityPositiveResponseRequested=!1,this.userIdentityPrimaryField="",this.userIdentitySecondaryField="",this.negotiateUserIdentityServerResponse=!1,this.userIdentityServerResponse=""}getCallingAeTitle(){return this.callingAeTitle}setCallingAeTitle(e){this.callingAeTitle=e}getCalledAeTitle(){return this.calledAeTitle}setCalledAeTitle(e){this.calledAeTitle=e}getMaxPduLength(){return this.maxPduLength}setMaxPduLength(e){this.maxPduLength=e}getApplicationContextName(){return this.applicationContextName}getImplementationClassUid(){return this.implementationClassUid}setImplementationClassUid(e){this.implementationClassUid=e}getImplementationVersion(){return this.implementationVersion}setImplementationVersion(e){this.implementationVersion=e}getNegotiateAsyncOps(){return this.negotiateAsyncOps}setNegotiateAsyncOps(e){this.negotiateAsyncOps=e}getMaxAsyncOpsInvoked(){return this.maxAsyncOpsInvoked}setMaxAsyncOpsInvoked(e){this.maxAsyncOpsInvoked=e}getMaxAsyncOpsPerformed(){return this.maxAsyncOpsPerformed}setMaxAsyncOpsPerformed(e){this.maxAsyncOpsPerformed=e}getNegotiateUserIdentity(){return this.negotiateUserIdentity}setNegotiateUserIdentity(e){this.negotiateUserIdentity=e}getUserIdentityType(){return this.userIdentityType}setUserIdentityType(e){this.userIdentityType=e}getUserIdentityPositiveResponseRequested(){return this.userIdentityPositiveResponseRequested}setUserIdentityPositiveResponseRequested(e){this.userIdentityPositiveResponseRequested=e}getUserIdentityPrimaryField(){return this.userIdentityPrimaryField}setUserIdentityPrimaryField(e){this.userIdentityPrimaryField=e}getUserIdentitySecondaryField(){return this.userIdentitySecondaryField}setUserIdentitySecondaryField(e){this.userIdentitySecondaryField=e}getNegotiateUserIdentityServerResponse(){return this.negotiateUserIdentityServerResponse}setNegotiateUserIdentityServerResponse(e){this.negotiateUserIdentityServerResponse=e}getUserIdentityServerResponse(){return this.userIdentityServerResponse}setUserIdentityServerResponse(e){this.userIdentityServerResponse=e}addPresentationContext(e,t){let s=t||1;return this.presentationContexts.forEach((e=>{const t=e.id;t>=s&&(s=t+2)})),this.presentationContexts.push({id:s,context:new l(s,e)}),s}addOrGetPresentationContext(e){const t=this.getPresentationContexts();for(let s=0;s<t.length;s++){const n=t[s];if(n.context.getAbstractSyntaxUid()===e)return n.context.getPresentationContextId()}return this.addPresentationContext(e)}addTransferSyntaxToPresentationContext(e,t){this.getPresentationContext(e).addTransferSyntaxUid(t)}findPresentationContextByAbstractSyntaxAndTransferSyntax(e,t){const s=this.getPresentationContexts();for(let n=0;n<s.length;n++){const i=s[n];if(i.context.getAbstractSyntaxUid()===e&&i.context.hasTransferSyntaxUid(t))return i.context.getPresentationContextId()}}getPresentationContext(e){const t=this.presentationContexts.find((t=>t.id===e));if(!t)throw new Error(`Invalid presentation context ID: ${e}`);return t.context}getPresentationContexts(){return this.presentationContexts}clearPresentationContexts(){this.presentationContexts.length=0}addPresentationContextFromRequest(e,t){let s=t||d.ImplicitVRLittleEndian;s=Array.isArray(s)?s:[s];const r=this._sopClassFromRequest(e);let o;if(e instanceof i){o=this.addOrGetPresentationContext(r),s.forEach((e=>{this.addTransferSyntaxToPresentationContext(o,e)}));const t=e.getDataset().getTransferSyntaxUid();t!==d.ImplicitVRLittleEndian&&t!==d.ExplicitVRLittleEndian&&(o=this.findPresentationContextByAbstractSyntaxAndTransferSyntax(r,t),void 0===o&&(o=this.addPresentationContext(r),this.addTransferSyntaxToPresentationContext(o,t)))}else e instanceof n?(o=this.addOrGetPresentationContext(r),s.forEach((e=>{this.addTransferSyntaxToPresentationContext(o,e)})),!0===e.getAddStorageSopClassesToAssociation()&&Object.keys(c).forEach((e=>{const t=c[e],n=this.addOrGetPresentationContext(t);s.forEach((e=>{this.addTransferSyntaxToPresentationContext(n,e)}))}))):(o=this.addOrGetPresentationContext(r),s.forEach((e=>{this.addTransferSyntaxToPresentationContext(o,e)})));return o}getAcceptedPresentationContextFromRequest(e){let t;const s=this.getPresentationContexts();return e.getDataset()&&s.forEach((s=>{const n=this.getPresentationContext(s.id);n.getAbstractSyntaxUid()===this._sopClassFromRequest(e)&&n.getAcceptedTransferSyntaxUid()===e.getDataset().getTransferSyntaxUid()&&n.getResult()===o.Accept&&(t=n)})),void 0===t&&s.forEach((s=>{const n=this.getPresentationContext(s.id);n.getAbstractSyntaxUid()===this._sopClassFromRequest(e)&&n.getResult()===o.Accept&&(t=n)})),t}toString(){const e=[];return e.push(`Application Context:     ${this.getApplicationContextName()}`),e.push(`Implementation Class:    ${this.getImplementationClassUid()}`),e.push(`Implementation Version:  ${this.getImplementationVersion()}`),e.push(`Maximum PDU Length:      ${this.getMaxPduLength()}`),e.push(`Called AE Title:         ${this.getCalledAeTitle()}`),e.push(`Calling AE Title:        ${this.getCallingAeTitle()}`),this.getNegotiateAsyncOps()&&e.push(`Asynchronous Operations: Invoked: ${this.getMaxAsyncOpsInvoked()} Performed:${this.getMaxAsyncOpsPerformed()}`),this.getNegotiateUserIdentity()&&e.push(`User Identity:           ${this._userIdentityTypeToString(this.getUserIdentityType())||""}`),e.push(`Presentation Contexts:   ${this.presentationContexts.length}`),this.presentationContexts.forEach((t=>{const s=this.getPresentationContext(t.id);e.push(`  Presentation Context:  ${t.id} [${s.getResultDescription()}]`),e.push(`      Abstract:  ${this._uidNameFromValue([a,c],s.getAbstractSyntaxUid())||s.getAbstractSyntaxUid()}`),s.getTransferSyntaxUids().forEach((t=>{e.push(`      Transfer:  ${this._uidNameFromValue(d,t)||t}`)}))})),e.push(""),e.join(g)}_uidNameFromValue(e,t){const s=Array.isArray(e)?Object.assign({},...e):e;return Object.keys(s).find((e=>s[e]===t))}_sopClassFromRequest(e){switch(e.getCommandFieldType()){case r.NGetRequest:case r.NSetRequest:case r.NActionRequest:case r.NDeleteRequest:return e.getRequestedSopClassUid();case r.CStoreRequest:case r.CFindRequest:case r.CGetRequest:case r.CMoveRequest:case r.CEchoRequest:case r.NEventReportRequest:case r.NCreateRequest:default:return e.getAffectedSopClassUid()}}_userIdentityTypeToString(e){switch(e){case h.Username:return"Username";case h.UsernameAndPasscode:return"Username and Passcode";case h.Kerberos:return"Kerberos Service Ticket";case h.Saml:return"SAML Assertion";case h.Jwt:return"JSON Web Token";default:return`${e}`}}},PresentationContext:l}},422:(e,t,s)=>{const{Association:n,PresentationContext:i}=s(570),{TransferSyntax:r,UserIdentityType:o}=s(492),{Request:a}=s(940),c=s(371),d=s(906),u=s(547),h=s(733),m=s(278),g=s(756);e.exports=class extends h{constructor(){super(),this.requests=[],this.additionalPresentationContexts=[],this.network=void 0,this.statistics=new d}addRequest(e){if(!(e instanceof a))throw new Error(`${e.toString()} is not a request`);this.requests.includes(e)?u.warn(`${e.toString()} request has already been added. Ignoring...`):this.requests.push(e)}clearRequests(){this.requests.length=0}addAdditionalPresentationContext(e,t){if(t=t||!1,!(e instanceof i))throw new Error(`${e.toString()} is not a presentation context`);this.additionalPresentationContexts.some((t=>t.context===e))?u.warn(`${e.toString()} context has already been added. Ignoring...`):this.additionalPresentationContexts.push({context:e,addAsNew:t})}send(e,t,s,i,a){if(a=a||{},this.associationLingerTimeout=a.associationLingerTimeout||0,0===this.requests.length)throw new Error("There are no requests to perform");const d=new n(s,i);a.asyncOps&&(d.setMaxAsyncOpsInvoked(a.asyncOps.maxAsyncOpsInvoked||1),d.setMaxAsyncOpsPerformed(a.asyncOps.maxAsyncOpsPerformed||1),d.setNegotiateAsyncOps(1!==d.getMaxAsyncOpsInvoked()||1!==d.getMaxAsyncOpsPerformed())),a.userIdentity&&(d.setUserIdentityType(a.userIdentity.type||o.Username),d.setUserIdentityPositiveResponseRequested(a.userIdentity.positiveResponseRequested||!1),d.setUserIdentityPrimaryField(a.userIdentity.primaryField||""),d.setUserIdentitySecondaryField(a.userIdentity.secondaryField||""),d.setNegotiateUserIdentity(!0)),this.requests.forEach((e=>{d.addPresentationContextFromRequest(e,[r.ImplicitVRLittleEndian,r.ExplicitVRLittleEndian])})),this.additionalPresentationContexts.forEach((e=>{const t=e.addAsNew?d.addPresentationContext(e.context.getAbstractSyntaxUid()):d.addOrGetPresentationContext(e.context.getAbstractSyntaxUid());e.context.getTransferSyntaxUids().forEach((e=>{d.addTransferSyntaxToPresentationContext(t,e)}))}));let h={};a.securityOptions&&(h={key:a.securityOptions.key,cert:a.securityOptions.cert,ca:a.securityOptions.ca,requestCert:a.securityOptions.requestCert,rejectUnauthorized:a.securityOptions.rejectUnauthorized,minVersion:a.securityOptions.minVersion,maxVersion:a.securityOptions.maxVersion,ciphers:a.securityOptions.ciphers}),u.info(`Connecting to ${e}:${t} ${a.securityOptions?"(TLS)":""}`);const l=(a.securityOptions?g:m).connect({host:e,port:t,...h}),p=new c(l,a);p.on("connect",(()=>{this.emit("connected"),p.sendAssociationRequest(d)})),p.on("associationAccepted",(e=>{this.emit("associationAccepted",e),p.sendRequests(this.requests)})),p.on("associationReleaseResponse",(()=>{this.emit("associationReleased"),l.end()})),p.on("associationRejected",(e=>{this.emit("associationRejected",e),l.end()})),p.on("done",(()=>{setTimeout((()=>p.sendAssociationReleaseRequest()),this.associationLingerTimeout)})),p.on("cStoreRequest",((e,t)=>{this.emit("cStoreRequest",e,t)})),p.on("nEventReportRequest",((e,t)=>{this.emit("nEventReportRequest",e,t)})),p.on("networkError",(e=>{l.end(),this.emit("networkError",e)})),p.on("close",(()=>{this.statistics.addFromOtherStatistics(p.getStatistics()),this.network=void 0,this.emit("closed")})),this.network=p}getStatistics(){return this.statistics}abort(e,t){if(!this.network)throw new Error("Network has not been initialized");this.network.sendAbort(e,t)}cancel(e){if(!this.network)throw new Error("Network has not been initialized");this.network.sendCancel(e)}}},940:(e,t,s)=>{const{CommandFieldType:n,Priority:i,SopClass:r,Status:o}=s(492),a=s(825),{Mixin:c}=s(429),{EOL:d}=s(857),u=s(733),h=s(111),{DicomMetaDictionary:m}=h.data;class g{constructor(e,t){this.commandDataset=e||new a,this.dataset=t}getCommandDataset(){return this.commandDataset}setCommandDataset(e){this.commandDataset=e}getDataset(){return this.dataset}setDataset(e){this.dataset=e,this.commandDataset.setElement("CommandDataSetType",this.dataset?514:257)}getCommandFieldType(){return this.commandDataset.getElement("CommandField")}hasDataset(){return 257!==this.commandDataset.getElement("CommandDataSetType")}toString(e){const t=e||{},s=t.includeCommandDataset||!1,n=t.includeDataset||!1,i=[];return i.push(`${this._typeToString(this.getCommandFieldType())} [HasDataset: ${this.hasDataset()}]`),s&&(i.push("DIMSE Command Dataset:"),i.push("=".repeat(50)),i.push(JSON.stringify(this.commandDataset.getElements()))),n&&this.dataset&&(i.push("DIMSE Dataset:"),i.push("=".repeat(50)),i.push(JSON.stringify(this.dataset.getElements()))),i.join(d)}_typeToString(e){switch(e){case n.CCancelRequest:return"C-CANCEL RQ";case n.CEchoRequest:return"C-ECHO RQ";case n.CEchoResponse:return"C-ECHO RSP";case n.CFindRequest:return"C-FIND RQ";case n.CFindResponse:return"C-FIND RSP";case n.CGetRequest:return"C-GET RQ";case n.CGetResponse:return"C-GET RSP";case n.CMoveRequest:return"C-MOVE RQ";case n.CMoveResponse:return"C-MOVE RSP";case n.CStoreRequest:return"C-STORE RQ";case n.CStoreResponse:return"C-STORE RSP";case n.NActionRequest:return"N-ACTION RQ";case n.NActionResponse:return"N-ACTION RSP";case n.NCreateRequest:return"N-CREATE RQ";case n.NCreateResponse:return"N-CREATE RSP";case n.NDeleteRequest:return"N-DELETE RQ";case n.NDeleteResponse:return"N-DELETE RSP";case n.NEventReportRequest:return"N-EVENT-REPORT RQ";case n.NEventReportResponse:return"N-EVENT-REPORT RSP";case n.NGetRequest:return"N-GET RQ";case n.NGetResponse:return"N-GET RSP";case n.NSetRequest:return"N-SET RQ";case n.NSetResponse:return"N-SET RSP";default:return`${e}`}}}class l extends(c(g,u)){constructor(e,t,s){switch(super(new a({CommandField:e,CommandDataSetType:s?514:257})),e){case n.NGetRequest:case n.NSetRequest:case n.NActionRequest:case n.NDeleteRequest:this.setRequestedSopClassUid(t);break;default:this.setAffectedSopClassUid(t)}}getAffectedSopClassUid(){return this.getCommandDataset().getElement("AffectedSOPClassUID")}setAffectedSopClassUid(e){this.getCommandDataset().setElement("AffectedSOPClassUID",e)}getRequestedSopClassUid(){return this.getCommandDataset().getElement("RequestedSOPClassUID")}setRequestedSopClassUid(e){this.getCommandDataset().setElement("RequestedSOPClassUID",e)}getAffectedSopInstanceUid(){return this.getCommandDataset().getElement("AffectedSOPInstanceUID")}setAffectedSopInstanceUid(e){this.getCommandDataset().setElement("AffectedSOPInstanceUID",e)}getRequestedSopInstanceUid(){return this.getCommandDataset().getElement("RequestedSOPInstanceUID")}setRequestedSopInstanceUid(e){this.getCommandDataset().setElement("RequestedSOPInstanceUID",e)}getMessageId(){return this.getCommandDataset().getElement("MessageID")}setMessageId(e){this.getCommandDataset().setElement("MessageID",e)}raiseResponseEvent(e){this.emit("response",e)}raiseInstanceEvent(e){this.emit("instance",e)}raiseDoneEvent(){this.emit("done")}toString(e){return`${super.toString(e)} [id: ${this.getMessageId()||""}]`}}class p extends g{constructor(e,t,s,i,r){switch(super(new a({CommandField:e,CommandDataSetType:s?514:257,Status:i,ErrorComment:r})),e){case n.NGetRequest:case n.NSetRequest:case n.NActionRequest:case n.NDeleteRequest:this.setRequestedSopClassUid(t);break;default:this.setAffectedSopClassUid(t)}}getAffectedSopClassUid(){return this.getCommandDataset().getElement("AffectedSOPClassUID")}setAffectedSopClassUid(e){this.getCommandDataset().setElement("AffectedSOPClassUID",e)}getRequestedSopClassUid(){return this.getCommandDataset().getElement("RequestedSOPClassUID")}setRequestedSopClassUid(e){this.getCommandDataset().setElement("RequestedSOPClassUID",e)}getAffectedSopInstanceUid(){return this.getCommandDataset().getElement("AffectedSOPInstanceUID")}setAffectedSopInstanceUid(e){this.getCommandDataset().setElement("AffectedSOPInstanceUID",e)}getRequestedSopInstanceUid(){return this.getCommandDataset().getElement("RequestedSOPInstanceUID")}setRequestedSopInstanceUid(e){this.getCommandDataset().setElement("RequestedSOPInstanceUID",e)}getStatus(){return this.getCommandDataset().getElement("Status")}setStatus(e){this.getCommandDataset().setElement("Status",e)}getErrorComment(){return this.getCommandDataset().getElement("ErrorComment")}setErrorComment(e){this.getCommandDataset().setElement("ErrorComment",e)}getMessageIdBeingRespondedTo(){return this.getCommandDataset().getElement("MessageIDBeingRespondedTo")}setMessageIdBeingRespondedTo(e){this.getCommandDataset().setElement("MessageIDBeingRespondedTo",e)}toString(e){return`${super.toString(e)} [id: ${this.getMessageIdBeingRespondedTo()||""}; status: ${this._statusToString(this.getStatus())}]`}_statusToString(e){switch(e){case o.Success:return"Success";case o.Cancel:return"Cancel";case o.Pending:return"Pending";case o.SopClassNotSupported:return"SOP Class Not Supported";case o.ClassInstanceConflict:return"Class Instance Conflict";case o.DuplicateSOPInstance:return"Duplicate SOP Instance";case o.DuplicateInvocation:return"Duplicate Invocation";case o.InvalidArgumentValue:return"Invalid Argument Value";case o.InvalidAttributeValue:return"Invalid Attribute Value";case o.InvalidObjectInstance:return"Invalid Object Instance";case o.MissingAttribute:return"Missing Attribute";case o.MissingAttributeValue:return"Missing Attribute Value";case o.MistypedArgument:return"Mistyped Argument";case o.NoSuchArgument:return"No Such Argument";case o.NoSuchEventType:return"No Such Event Type";case o.NoSuchObjectInstance:return"No Such Object Instance";case o.NoSuchSopClass:return"No Such SOP Class";case o.ProcessingFailure:return"Processing Failure";case o.ResourceLimitation:return"Resource Limitation";case o.UnrecognizedOperation:return"Unrecognized Operation";case o.NoSuchActionType:return"No Such Action Type";default:return`${e}`}}}class R extends l{constructor(){super(n.CEchoRequest,r.Verification,!1)}}class f extends p{constructor(e,t){super(n.CEchoResponse,r.Verification,!1,e,t)}static fromRequest(e){if(!(e instanceof R))throw new Error("Request should be an instance of CEchoRequest");const t=new f(o.ProcessingFailure);return t.setMessageIdBeingRespondedTo(e.getMessageId()),t}}class y extends l{constructor(e){super(n.CFindRequest,r.StudyRootQueryRetrieveInformationModelFind,!1),this.setPriority(e||i.Medium)}getPriority(){return this.getCommandDataset().getElement("Priority")}setPriority(e){this.getCommandDataset().setElement("Priority",e)}static createStudyFindRequest(e,t){const s={PatientID:"",PatientName:"",IssuerOfPatientID:"",PatientSex:"",PatientBirthDate:"",StudyInstanceUID:"",ModalitiesInStudy:"",StudyID:"",AccessionNumber:"",StudyDate:"",StudyTime:"",StudyDescription:"",NumberOfStudyRelatedSeries:"",NumberOfStudyRelatedInstances:"",...e};s.QueryRetrieveLevel="STUDY";const n=new y(t);return n.setDataset(new a(s)),n}static createSeriesFindRequest(e,t){const s={StudyInstanceUID:"",SeriesInstanceUID:"",SeriesNumber:"",SeriesDescription:"",Modality:"",SeriesDate:"",SeriesTime:"",NumberOfSeriesRelatedInstances:"",...e};s.QueryRetrieveLevel="SERIES";const n=new y(t);return n.setDataset(new a(s)),n}static createImageFindRequest(e,t){const s={StudyInstanceUID:"",SeriesInstanceUID:"",SOPInstanceUID:"",InstanceNumber:"",Modality:"",...e};s.QueryRetrieveLevel="IMAGE";const n=new y(t);return n.setDataset(new a(s)),n}static createWorklistFindRequest(e,t){const s={PatientID:"",PatientName:"",IssuerOfPatientID:"",PatientSex:"",PatientWeight:"",PatientBirthDate:"",MedicalAlerts:"",PregnancyStatus:"",Allergies:"",PatientComments:"",SpecialNeeds:"",PatientState:"",CurrentPatientLocation:"",InstitutionName:"",AdmissionID:"",AccessionNumber:"",ReferringPhysicianName:"",AdmittingDiagnosesDescription:"",RequestingPhysician:"",StudyInstanceUID:"",StudyDescription:"",StudyID:"",ReasonForTheRequestedProcedure:"",StudyDate:"",StudyTime:"",RequestedProcedureID:"",RequestedProcedureDescription:"",RequestedProcedurePriority:"",RequestedProcedureCodeSequence:[],ReferencedStudySequence:[],ProcedureCodeSequence:[],ScheduledProcedureStepSequence:[{ScheduledStationAETitle:"",ScheduledStationName:"",ScheduledProcedureStepStartDate:"",ScheduledProcedureStepStartTime:"",Modality:"",ScheduledPerformingPhysicianName:"",ScheduledProcedureStepDescription:"",ScheduledProtocolCodeSequence:[],ScheduledProcedureStepLocation:"",ScheduledProcedureStepID:"",RequestedContrastAgent:"",PreMedication:"",AnatomicalOrientationType:""}],...e};s.QueryRetrieveLevel="";const n=new y(t);return n.setAffectedSopClassUid(r.ModalityWorklistInformationModelFind),n.setDataset(new a(s)),n}}class S extends p{constructor(e,t){super(n.CFindResponse,r.StudyRootQueryRetrieveInformationModelFind,!1,e,t)}static fromRequest(e){if(!(e instanceof y))throw new Error("Request should be an instance of CFindRequest");const t=new S(o.ProcessingFailure);return t.setMessageIdBeingRespondedTo(e.getMessageId()),t}}class I extends l{constructor(e,t){if(super(n.CStoreRequest,"",!1),this.setPriority(t||i.Medium),e instanceof a)return this.setAffectedSopClassUid(e.getElement("SOPClassUID")),this.setAffectedSopInstanceUid(e.getElement("SOPInstanceUID")),void this.setDataset(e);if("string"==typeof e||e instanceof String){const t=a.fromFile(e,void 0,{untilTag:"00080018",includeUntilTagValue:!0});this.setAffectedSopClassUid(t.getElement("SOPClassUID")),this.setAffectedSopInstanceUid(t.getElement("SOPInstanceUID")),this.setDataset(t),this.needsFullDatasetLoading=!0,this.datasetOrFile=e}}getPriority(){return this.getCommandDataset().getElement("Priority")}setPriority(e){this.getCommandDataset().setElement("Priority",e)}loadFullDatasetIfNeeded(){void 0!==this.needsFullDatasetLoading&&!0===this.needsFullDatasetLoading&&void 0!==this.datasetOrFile&&""!==this.datasetOrFile.trim()&&this.setDataset(a.fromFile(this.datasetOrFile))}}class C extends p{constructor(e,t){super(n.CStoreResponse,"",!1,e,t)}static fromRequest(e){if(!(e instanceof I))throw new Error("Request should be an instance of CStoreRequest");const t=new C(o.ProcessingFailure);return t.setMessageIdBeingRespondedTo(e.getMessageId()),t.setAffectedSopClassUid(e.getAffectedSopClassUid()),t.setAffectedSopInstanceUid(e.getAffectedSopInstanceUid()),t}}class P extends l{constructor(e){super(n.CMoveRequest,r.StudyRootQueryRetrieveInformationModelMove,!1),this.setPriority(e||i.Medium)}getPriority(){return this.getCommandDataset().getElement("Priority")}setPriority(e){this.getCommandDataset().setElement("Priority",e)}static createStudyMoveRequest(e,t,s){const n={StudyInstanceUID:t,QueryRetrieveLevel:"STUDY"},i=new P(s);return i.setDataset(new a(n)),i.getCommandDataset().setElement("MoveDestination",e),i}static createSeriesMoveRequest(e,t,s,n){const i={StudyInstanceUID:t,SeriesInstanceUID:s,QueryRetrieveLevel:"SERIES"},r=new P(n);return r.setDataset(new a(i)),r.getCommandDataset().setElement("MoveDestination",e),r}static createImageMoveRequest(e,t,s,n,i){const r={StudyInstanceUID:t,SeriesInstanceUID:s,SOPInstanceUID:n,QueryRetrieveLevel:"IMAGE"},o=new P(i);return o.setDataset(new a(r)),o.getCommandDataset().setElement("MoveDestination",e),o}}class v extends p{constructor(e,t){super(n.CMoveResponse,r.StudyRootQueryRetrieveInformationModelMove,!1,e,t)}getRemaining(){return this.getCommandDataset().getElement("NumberOfRemainingSuboperations")}getCompleted(){return this.getCommandDataset().getElement("NumberOfCompletedSuboperations")}getWarnings(){return this.getCommandDataset().getElement("NumberOfWarningSuboperations")}getFailures(){return this.getCommandDataset().getElement("NumberOfFailedSuboperations")}static fromRequest(e){if(!(e instanceof P))throw new Error("Request should be an instance of CMoveRequest");const t=new v(o.ProcessingFailure);return t.setMessageIdBeingRespondedTo(e.getMessageId()),t}}class x extends l{constructor(e){super(n.CGetRequest,r.StudyRootQueryRetrieveInformationModelGet,!1),this.setPriority(e||i.Medium),this.addStorageSopClassesToAssociation=!0}getPriority(){return this.getCommandDataset().getElement("Priority")}setPriority(e){this.getCommandDataset().setElement("Priority",e)}getAddStorageSopClassesToAssociation(){return this.addStorageSopClassesToAssociation}setAddStorageSopClassesToAssociation(e){this.addStorageSopClassesToAssociation=e}static createStudyGetRequest(e,t){const s={StudyInstanceUID:e,QueryRetrieveLevel:"STUDY"},n=new x(t);return n.setDataset(new a(s)),n}static createSeriesGetRequest(e,t,s){const n={StudyInstanceUID:e,SeriesInstanceUID:t,QueryRetrieveLevel:"SERIES"},i=new x(s);return i.setDataset(new a(n)),i}static createImageGetRequest(e,t,s,n){const i={StudyInstanceUID:e,SeriesInstanceUID:t,SOPInstanceUID:s,QueryRetrieveLevel:"IMAGE"},r=new x(n);return r.setDataset(new a(i)),r}}class w extends p{constructor(e,t){super(n.CGetResponse,r.StudyRootQueryRetrieveInformationModelGet,!1,e,t)}getRemaining(){return this.getCommandDataset().getElement("NumberOfRemainingSuboperations")}getCompleted(){return this.getCommandDataset().getElement("NumberOfCompletedSuboperations")}getWarnings(){return this.getCommandDataset().getElement("NumberOfWarningSuboperations")}getFailures(){return this.getCommandDataset().getElement("NumberOfFailedSuboperations")}static fromRequest(e){if(!(e instanceof x))throw new Error("Request should be an instance of CGetRequest");const t=new w(o.ProcessingFailure);return t.setMessageIdBeingRespondedTo(e.getMessageId()),t}}class A extends l{constructor(e,t){super(n.NCreateRequest,e,!1),this.setAffectedSopInstanceUid(t)}}class U extends p{constructor(e,t,s,i){super(n.NCreateResponse,e,!1,s,i),this.setAffectedSopInstanceUid(t)}static fromRequest(e){if(!(e instanceof A))throw new Error("Request should be an instance of NCreateRequest");const t=new U(e.getAffectedSopClassUid(),e.getAffectedSopInstanceUid(),o.ProcessingFailure);return t.setMessageIdBeingRespondedTo(e.getMessageId()),t}}class q extends l{constructor(e,t,s){super(n.NActionRequest,e,!1),this.setRequestedSopInstanceUid(t),this.setActionTypeId(s)}getActionTypeId(){return this.getCommandDataset().getElement("ActionTypeID")}setActionTypeId(e){this.getCommandDataset().setElement("ActionTypeID",e)}}class D extends p{constructor(e,t,s,i,r){super(n.NActionResponse,e,!1,i,r),this.setAffectedSopInstanceUid(t),this.setActionTypeId(s)}getActionTypeId(){return this.getCommandDataset().getElement("ActionTypeID")}setActionTypeId(e){this.getCommandDataset().setElement("ActionTypeID",e)}static fromRequest(e){if(!(e instanceof q))throw new Error("Request should be an instance of NActionRequest");const t=new D(e.getRequestedSopClassUid(),e.getRequestedSopInstanceUid(),e.getActionTypeId(),o.ProcessingFailure);return t.setMessageIdBeingRespondedTo(e.getMessageId()),t}}class E extends l{constructor(e,t){super(n.NDeleteRequest,e,!1),this.setRequestedSopInstanceUid(t)}}class T extends p{constructor(e,t,s,i){super(n.NDeleteResponse,e,!1,s,i),this.setAffectedSopInstanceUid(t)}static fromRequest(e){if(!(e instanceof E))throw new Error("Request should be an instance of NDeleteRequest");const t=new T(e.getRequestedSopClassUid(),e.getRequestedSopInstanceUid(),o.ProcessingFailure);return t.setMessageIdBeingRespondedTo(e.getMessageId()),t}}class b extends l{constructor(e,t,s){super(n.NEventReportRequest,e,!1),this.setAffectedSopInstanceUid(t),this.setEventTypeId(s)}getEventTypeId(){return this.getCommandDataset().getElement("EventTypeID")}setEventTypeId(e){this.getCommandDataset().setElement("EventTypeID",e)}}class O extends p{constructor(e,t,s,i,r){super(n.NEventReportResponse,e,!1,i,r),this.setAffectedSopInstanceUid(t),this.setEventTypeId(s)}getEventTypeId(){return this.getCommandDataset().getElement("EventTypeID")}setEventTypeId(e){this.getCommandDataset().setElement("EventTypeID",e)}static fromRequest(e){if(!(e instanceof b))throw new Error("Request should be an instance of NEventReportRequest");const t=new O(e.getAffectedSopClassUid(),e.getAffectedSopInstanceUid(),e.getEventTypeId(),o.ProcessingFailure);return t.setMessageIdBeingRespondedTo(e.getMessageId()),t}}class N extends l{constructor(e,t,s){super(n.NGetRequest,e,!1),this.setRequestedSopInstanceUid(t),this.setAttributeIdentifierList(Array.isArray(s)?s:[s])}getAttributeIdentifierList(){const e=this.getCommandDataset().getElement("AttributeIdentifierList"),t=[];return void 0!==e&&Array.isArray(e)&&e.length>0&&e.forEach((e=>{const s=e>>16,n=65535&e,i=`(${this._getPaddedHexString(s,4)},${this._getPaddedHexString(n,4)})`,r=m.dictionary[i.toUpperCase()];r&&t.push(r.name)})),t}setAttributeIdentifierList(e){const t=[];Object.keys(m.dictionary).forEach((s=>{const n=m.dictionary[s];if("DICOM"===n.version&&e.includes(n.name)){const e=parseInt(n.tag.substring(1,5),16),s=parseInt(n.tag.substring(6,10),16);t.push(e<<16|65535&s)}})),this.getCommandDataset().setElement("AttributeIdentifierList",t)}_getPaddedHexString(e,t){const s=e.toString(16);return"0".repeat(t-s.length)+s}}class B extends p{constructor(e,t,s,i){super(n.NGetResponse,e,!1,s,i),this.setAffectedSopInstanceUid(t)}static fromRequest(e){if(!(e instanceof N))throw new Error("Request should be an instance of NGetRequest");const t=new B(e.getRequestedSopClassUid(),e.getRequestedSopInstanceUid(),o.ProcessingFailure);return t.setMessageIdBeingRespondedTo(e.getMessageId()),t}}class M extends l{constructor(e,t){super(n.NSetRequest,e,!1),this.setRequestedSopInstanceUid(t)}}class L extends p{constructor(e,t,s,i){super(n.NSetResponse,e,!1,s,i),this.setAffectedSopInstanceUid(t)}static fromRequest(e){if(!(e instanceof M))throw new Error("Request should be an instance of NSetRequest");const t=new L(e.getRequestedSopClassUid(),e.getRequestedSopInstanceUid(),o.ProcessingFailure);return t.setMessageIdBeingRespondedTo(e.getMessageId()),t}}class F extends l{constructor(e,t){super(n.CCancelRequest,e,!1),this.setMessageIdBeingRespondedTo(t)}getMessageIdBeingRespondedTo(){return this.getCommandDataset().getElement("MessageIDBeingRespondedTo")}setMessageIdBeingRespondedTo(e){this.getCommandDataset().setElement("MessageIDBeingRespondedTo",e)}static fromRequest(e){if(!(e instanceof y||e instanceof P||e instanceof x))throw new Error("Request should be an instance of CFindRequest, CMoveRequest or CGetRequest");return new F(e.getAffectedSopClassUid(),e.getMessageId())}}e.exports={CCancelRequest:F,CEchoRequest:R,CEchoResponse:f,CFindRequest:y,CFindResponse:S,CGetRequest:x,CGetResponse:w,CMoveRequest:P,CMoveResponse:v,Command:g,CStoreRequest:I,CStoreResponse:C,NActionRequest:q,NActionResponse:D,NCreateRequest:A,NCreateResponse:U,NDeleteRequest:E,NDeleteResponse:T,NEventReportRequest:b,NEventReportResponse:O,NGetRequest:N,NGetResponse:B,NSetRequest:M,NSetResponse:L,Request:l,Response:p}},492:e=>{const t={CStoreRequest:1,CStoreResponse:32769,CGetRequest:16,CGetResponse:32784,CFindRequest:32,CFindResponse:32800,CMoveRequest:33,CMoveResponse:32801,CEchoRequest:48,CEchoResponse:32816,NEventReportRequest:256,NEventReportResponse:33024,NGetRequest:272,NGetResponse:33040,NSetRequest:288,NSetResponse:33056,NActionRequest:304,NActionResponse:33072,NCreateRequest:320,NCreateResponse:33088,NDeleteRequest:336,NDeleteResponse:33104,CCancelRequest:4095};Object.freeze(t);const s={Proposed:255,Accept:0,RejectUser:1,RejectNoReason:2,RejectAbstractSyntaxNotSupported:3,RejectTransferSyntaxesNotSupported:4};Object.freeze(s);const n={Username:1,UsernameAndPasscode:2,Kerberos:3,Saml:4,Jwt:5};Object.freeze(n);const i={ServiceUser:0,Unknown:1,ServiceProvider:2};Object.freeze(i);const r={NotSpecified:0,UnrecognizedPdu:1,UnexpectedPdu:2,UnrecognizedPduParameter:4,UnexpectedPduParameter:5,InvalidPduParameter:6};Object.freeze(r);const o={Permanent:1,Transient:2};Object.freeze(o);const a={ServiceUser:1,ServiceProviderAcse:2,ServiceProviderPresentation:3};Object.freeze(a);const c={NoReasonGiven:1,ApplicationContextNotSupported:2,CallingAeNotRecognized:3,CalledAeNotRecognized:7,ProtocolVersionNotSupported:2,TemporaryCongestion:1,LocalLimitExceeded:2};Object.freeze(c);const d={Low:2,Medium:0,High:1};Object.freeze(d);const u={Success:0,Cancel:65024,Pending:65280,ClassInstanceConflict:281,DataSetSopClassMismatch:43264,DuplicateSOPInstance:273,DuplicateInvocation:528,InvalidArgumentValue:277,InvalidAttributeValue:262,InvalidObjectInstance:279,MissingAttribute:288,MissingAttributeValue:289,MistypedArgument:530,MoveDestinationUnknown:43009,NoSuchActionType:291,NoSuchArgument:276,NoSuchEventType:275,NoSuchObjectInstance:274,NoSuchSopClass:280,NotAuthorized:292,OutOfResourcesNumberOfMatches:42753,OutOfResourcesSubOperations:42754,ProcessingFailure:272,ResourceLimitation:531,SopClassNotSupported:290,UnrecognizedOperation:529};Object.freeze(u);const h={ApplicationContextName:"1.2.840.10008.3.1.1.1"};Object.freeze(h);const m={BasicTextSrStorage:"1.2.840.10008.5.1.4.1.1.88.11",BreastProjectionXRayImageStorageForPresentation:"1.2.840.10008.5.1.4.1.1.13.1.4",BreastProjectionXRayImageStorageForProcessing:"1.2.840.10008.5.1.4.1.1.13.1.5",BreastTomosynthesisImageStorage:"1.2.840.10008.5.1.4.1.1.13.1.3",ChestCadSrStorage:"1.2.840.10008.5.1.4.1.1.88.65",ComprehensiveSrStorage:"1.2.840.10008.5.1.4.1.1.88.33",ComputedRadiographyImageStorage:"1.2.840.10008.5.1.4.1.1.1",CtImageStorage:"1.2.840.10008.5.1.4.1.1.2",DigitalIntraOralXRayImageStorageForPresentation:"1.2.840.10008.5.1.4.1.1.1.3",DigitalIntraOralXRayImageStorageForProcessing:"1.2.840.10008.5.1.4.1.1.1.3.1",DigitalMammographyXRayImageStorageForPresentation:"1.2.840.10008.5.1.4.1.1.1.2",DigitalMammographyXRayImageStorageForProcessing:"1.2.840.10008.5.1.4.1.1.1.2.1",DigitalXRayImageStorageForPresentation:"1.2.840.10008.5.1.4.1.1.1.1",DigitalXRayImageStorageForProcessing:"1.2.840.10008.5.1.4.1.1.1.1.1",EncapsulatedCdaStorage:"1.2.840.10008.5.1.4.1.1.104.2",EncapsulatedPdfStorage:"1.2.840.10008.5.1.4.1.1.104.1",EnhancedCtImageStorage:"1.2.840.10008.5.1.4.1.1.2.1",EnhancedMrColorImageStorage:"1.2.840.10008.5.1.4.1.1.4.3",EnhancedMrImageStorage:"1.2.840.10008.5.1.4.1.1.4.1",EnhancedPetImageStorage:"1.2.840.10008.5.1.4.1.1.130",EnhancedSrStorage:"1.2.840.10008.5.1.4.1.1.88.22",EnhancedXaImageStorage:"1.2.840.10008.5.1.4.1.1.12.1.1",EnhancedXrfImageStorage:"1.2.840.10008.5.1.4.1.1.12.2.1",IntravascularOpticalCoherenceTomographyImageStorageForPresentation:"1.2.840.10008.5.1.4.1.1.14.1",IntravascularOpticalCoherenceTomographyImageStorageForProcessing:"1.2.840.10008.5.1.4.1.1.14.2",LegacyConvertedEnhancedCTImageStorage:"1.2.840.10008.5.1.4.1.1.2.2",LegacyConvertedEnhancedMRImageStorage:"1.2.840.10008.5.1.4.1.1.4.4",LegacyConvertedEnhancedPETImageStorage:"1.2.840.10008.5.1.4.1.1.128.1",MammographyCadSrStorage:"1.2.840.10008.5.1.4.1.1.88.50",MrImageStorage:"1.2.840.10008.5.1.4.1.1.4",MultiframeGrayscaleByteSecondaryCaptureImageStorage:"1.2.840.10008.5.1.4.1.1.7.2",MultiframeGrayscaleWordSecondaryCaptureImageStorage:"1.2.840.10008.5.1.4.1.1.7.3",MultiframeSingleBitSecondaryCaptureImageStorage:"1.2.840.10008.5.1.4.1.1.7.1",MultiframeTrueColorSecondaryCaptureImageStorage:"1.2.840.10008.5.1.4.1.1.7.4",NuclearMedicineImageStorage:"1.2.840.10008.5.1.4.1.1.20",OphthalmicOpticalCoherenceTomographyEnFaceImageStorage:"1.2.840.10008.5.1.4.1.1.77.1.5.7",OphthalmicPhotography16BitImageStorage:"1.2.840.10008.5.1.4.1.1.77.1.5.2",OphthalmicPhotography8BitImageStorage:"1.2.840.10008.5.1.4.1.1.77.1.5.1",OphthalmicTomographyImageStorage:"1.2.840.10008.5.1.4.1.1.77.1.5.4",PositronEmissionTomographyImageStorage:"1.2.840.10008.5.1.4.1.1.128",RtImageStorage:"1.2.840.10008.5.1.4.1.1.481.1",SecondaryCaptureImageStorage:"1.2.840.10008.5.1.4.1.1.7",UltrasoundImageStorage:"1.2.840.10008.5.1.4.1.1.6.1",UltrasoundMultiframeImageStorage:"1.2.840.10008.5.1.4.1.1.3.1",VideoEndoscopicImageStorage:"1.2.840.10008.5.1.4.1.1.77.1.1.1",VideoMicroscopicImageStorage:"1.2.840.10008.5.1.4.1.1.77.1.2.1",VideoPhotographicImageStorage:"1.2.840.10008.5.1.4.1.1.77.1.4.1",VlEndoscopicImageStorage:"1.2.840.10008.5.1.4.1.1.77.1.1",VlMicroscopicImageStorage:"1.2.840.10008.5.1.4.1.1.77.1.2",VlPhotographicImageStorage:"1.2.840.10008.5.1.4.1.1.77.1.4",VlSlideCoordinatesMicroscopicImageStorage:"1.2.840.10008.5.1.4.1.1.77.1.3",VlWholeSlideMicroscopyImageStorage:"1.2.840.10008.5.1.4.1.1.77.1.6",WideFieldOphthalmicPhotography3dCoordinatesImageStorage:"1.2.840.10008.5.1.4.1.1.77.1.5.6",WideFieldOphthalmicPhotographyStereographicProjectionImageStorage:"1.2.840.10008.5.1.4.1.1.77.1.5.5",XRay3dAngiographicImageStorage:"1.2.840.10008.5.1.4.1.1.13.1.1",XRay3dCraniofacialImageStorage:"1.2.840.10008.5.1.4.1.1.13.1.2",XRayAngiographicImageStorage:"1.2.840.10008.5.1.4.1.1.12.1",XRayRadiationDoseSRStorage:"1.2.840.10008.5.1.4.1.1.88.67",XRayRadiofluoroscopicImageStorage:"1.2.840.10008.5.1.4.1.1.12.2"};Object.freeze(m);const g={Verification:"1.2.840.10008.1.1",StudyRootQueryRetrieveInformationModelFind:"1.2.840.10008.5.1.4.1.2.2.1",ModalityWorklistInformationModelFind:"1.2.840.10008.5.1.4.31",ModalityPerformedProcedureStep:"1.2.840.10008.3.1.2.3.3",StudyRootQueryRetrieveInformationModelMove:"1.2.840.10008.5.1.4.1.2.2.2",StudyRootQueryRetrieveInformationModelGet:"1.2.840.10008.5.1.4.1.2.2.3",StorageCommitmentPushModel:"1.2.840.10008.1.20.1",BasicFilmSession:"1.2.840.10008.5.1.1.1",PrintJob:"1.2.840.10008.5.1.1.14",BasicAnnotationBox:"1.2.840.10008.5.1.1.15",Printer:"1.2.840.10008.5.1.1.16",PrinterConfigurationRetrieval:"1.2.840.10008.5.1.1.16.376",BasicGrayscalePrintManagementMeta:"1.2.840.10008.5.1.1.9",BasicColorPrintManagementMeta:"1.2.840.10008.5.1.1.18",BasicFilmBox:"1.2.840.10008.5.1.1.2",PresentationLut:"1.2.840.10008.5.1.1.23",BasicGrayscaleImageBox:"1.2.840.10008.5.1.1.4",BasicColorImageBox:"1.2.840.10008.5.1.1.4.1",InstanceAvailabilityNotification:"1.2.840.10008.5.1.4.33"};Object.freeze(g);const l={ImplicitVRLittleEndian:"1.2.840.10008.1.2",ExplicitVRLittleEndian:"1.2.840.10008.1.2.1",DeflatedExplicitVRLittleEndian:"1.2.840.10008.1.2.1.99",ExplicitVRBigEndian:"1.2.840.10008.1.2.2",RleLossless:"1.2.840.10008.1.2.5",JpegBaseline:"1.2.840.10008.1.2.4.50",JpegLossless:"1.2.840.10008.1.2.4.70",JpegLsLossless:"1.2.840.10008.1.2.4.80",JpegLsLossy:"1.2.840.10008.1.2.4.81",Jpeg2000Lossless:"1.2.840.10008.1.2.4.90",Jpeg2000Lossy:"1.2.840.10008.1.2.4.91"};Object.freeze(l);const p=[l.ImplicitVRLittleEndian,l.ExplicitVRLittleEndian];Object.freeze(p);const R={ImplementationClassUid:"1.2.826.0.1.3680043.10.854",ImplementationVersion:"DCMJS-DIMSE-V0.1",MaxPduLength:262144};Object.freeze(R),e.exports={AbortReason:r,AbortSource:i,CommandFieldType:t,DefaultImplementation:R,PresentationContextResult:s,Priority:d,RejectReason:c,RejectResult:o,RejectSource:a,SopClass:g,Status:u,StorageClass:m,TranscodableTransferSyntaxes:p,TransferSyntax:l,Uid:h,UserIdentityType:n}},825:(e,t,s)=>{const{StorageClass:n,TransferSyntax:i}=s(492),r=s(139),{readFile:o,readFileSync:a,writeFile:c,writeFileSync:d}=s(896),{EOL:u}=s(857),h=s(111),{DicomDict:m,DicomMessage:g,DicomMetaDictionary:l,ReadBufferStream:p,WriteBufferStream:R}=h.data,f=h.log;class y{constructor(e,t,s){s=s||{},s={ignoreErrors:!0,...s},f.level="error",this.transferSyntaxUid=t||i.ImplicitVRLittleEndian,Buffer.isBuffer(e)?this.elements=this._fromElementsBuffer(e,this.transferSyntaxUid,s):this.elements=e||{}}getElement(e){return this.elements[e]}setElement(e,t){this.elements[e]=t}getElements(){return this.elements}getTransferSyntaxUid(){return this.transferSyntaxUid}setTransferSyntaxUid(e){this.transferSyntaxUid=e}getDenaturalizedDataset(e,t){const s=t?l.denaturalizeDataset(this.getElements(),{...l.nameMap,...t}):l.denaturalizeDataset(this.getElements()),n=new R;return g.write(s,n,this.transferSyntaxUid,e),Buffer.from(n.getBuffer())}getDenaturalizedCommandDataset(){const e=l.denaturalizeDataset(this.getElements()),t=new R,s=new R;return g.write(e,s,i.ImplicitVRLittleEndian,{}),g.writeTagObject(t,"00000000","UL",s.size,i.ImplicitVRLittleEndian,{}),t.concat(s),Buffer.from(t.getBuffer())}static fromFile(e,t,s){if(!(void 0!==t&&t instanceof Function))return this._fromP10Buffer(a(e),s);o(e,((e,n)=>{if(e)t(e,void 0);else try{t(void 0,this._fromP10Buffer(n,s))}catch(e){t(e,void 0)}}))}toFile(e,t,s,i){const o={_meta:{FileMetaInformationVersion:new Uint8Array([0,1]).buffer,MediaStorageSOPClassUID:this.getElement("SOPClassUID")||n.SecondaryCaptureImageStorage,MediaStorageSOPInstanceUID:this.getElement("SOPInstanceUID")||y.generateDerivedUid(),TransferSyntaxUID:this.getTransferSyntaxUid(),ImplementationClassUID:r.getImplementationClassUid(),ImplementationVersionName:r.getImplementationVersion()},...this.getElements()},a=l.denaturalizeDataset(o._meta),u=new m(a);u.dict=s?l.denaturalizeDataset(o,{...l.nameMap,...s}):l.denaturalizeDataset(o),t instanceof Function?c(e,Buffer.from(u.write(i)),(e=>{t(e||void 0)})):d(e,Buffer.from(u.write(i)))}static generateDerivedUid(){return l.uid()}toString(){const e=[];return e.push("Dataset:"),e.push("=".repeat(50)),e.push(JSON.stringify(this.getElements())),e.join(u)}static _fromP10Buffer(e,t){t=t||{},t={ignoreErrors:!0,...t};const s=g.readFile(e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength),t),n=l.naturalizeDataset(s.meta).TransferSyntaxUID,i=l.naturalizeDataset(s.dict);return new y(i,n)}_fromElementsBuffer(e,t,s){const n=new p(e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)),r=t===i.ImplicitVRLittleEndian?i.ImplicitVRLittleEndian:t===i.ExplicitVRBigEndian?i.ExplicitVRBigEndian:i.ExplicitVRLittleEndian,o=g._read(n,r,s);return l.naturalizeDataset(o)}}e.exports=y},139:(e,t,s)=>{const{DefaultImplementation:n}=s(492);e.exports=class{static getImplementationClassUid(){return this.implementationClassUid||n.ImplementationClassUid}static setImplementationClassUid(e){this.implementationClassUid=e}static getImplementationVersion(){return this.implementationVersion||n.ImplementationVersion}static setImplementationVersion(e){if("string"!=typeof e||e.length>16)throw new Error("Implementation version should be a string with less than 16 characters");this.implementationVersion=e}static getMaxPduLength(){return this.maxPduLength||n.MaxPduLength}static setMaxPduLength(e){this.maxPduLength=e}}},371:(e,t,s)=>{const{Association:n}=s(570),{AAbort:i,AAssociateAC:r,AAssociateRJ:o,AAssociateRQ:a,AReleaseRP:c,AReleaseRQ:d,PDataTF:u,Pdv:h,RawPdu:m}=s(942),{CommandFieldType:g,Status:l,TranscodableTransferSyntaxes:p}=s(492),{CCancelRequest:R,CEchoRequest:f,CEchoResponse:y,CFindRequest:S,CFindResponse:I,CGetRequest:C,CGetResponse:P,CMoveRequest:v,CMoveResponse:x,Command:w,CStoreRequest:A,CStoreResponse:U,NActionRequest:q,NActionResponse:D,NCreateRequest:E,NCreateResponse:T,NDeleteRequest:b,NDeleteResponse:O,NEventReportRequest:N,NEventReportResponse:B,NGetRequest:M,NGetResponse:L,NSetRequest:F,NSetResponse:k,Response:$}=s(940),j=s(825),V=s(139),G=s(906),_=s(547),{SmartBuffer:z}=s(766),{EOL:Q}=s(857),W=s(733);class J extends W{constructor(){super()}accumulate(e){do{e=this._process(e)}while(void 0!==e)}_process(e){if(void 0===this.receiving){if(this.minimumReceived&&(e=Buffer.concat([this.minimumReceived,e],this.minimumReceived.length+e.length),this.minimumReceived=void 0),e.length<6)return void(this.minimumReceived=e);const t=z.fromBuffer(e,"ascii");t.readUInt8(),t.readUInt8();const s=t.readUInt32BE();let n=e.length-6;if(s>n)this.receiving=e,this.receivedLength=s;else{let t,i=e;if(s<n&&(i=e.slice(0,s+6),t=e.slice(s+6,n+6)),this.receiving=void 0,this.receivedLength=void 0,this.emit("pdu",i),t)return t}}else{let t=Buffer.concat([this.receiving,e],this.receiving.length+e.length);const s=t.length-6;if(s<this.receivedLength)this.receiving=t;else{let e;if(s>this.receivedLength&&(e=t.slice(this.receivedLength+6,s+6),t=t.slice(0,this.receivedLength+6)),this.receiving=void 0,this.receivedLength=void 0,this.emit("pdu",t),e)return e}}}}e.exports=class extends W{constructor(e,t){super(),this.messageId=0,this.socket=e,this.requests=[],this.pending=[],this.dimseBuffer=void 0,this.dimse=void 0,t=t||{},this.connectTimeout=t.connectTimeout||18e4,this.associationTimeout=t.associationTimeout||6e4,this.pduTimeout=t.pduTimeout||6e4,this.logCommandDatasets=t.logCommandDatasets||!1,this.logDatasets=t.logDatasets||!1,this.datasetReadOptions=t.datasetReadOptions||{},this.datasetWriteOptions=t.datasetWriteOptions||{},this.datasetNameMap=t.datasetNameMap||{},this.logId="",this.connected=!1,this.connectedTime=void 0,this.lastPduTime=void 0,this.timeoutIntervalId=void 0,this.statistics=new G,this._wrapSocket()}sendAssociationRequest(e){this.association=e;const t=new a(this.association).write();this.logId=this.association.getCalledAeTitle(),_.info(`${this.logId} -> Association request:${Q}${this.association.toString()}`),this._sendPdu(t)}sendAssociationAccept(){this.association.setImplementationClassUid(V.getImplementationClassUid()),this.association.setImplementationVersion(V.getImplementationVersion()),this.association.setMaxPduLength(Math.min(this.association.getMaxPduLength(),V.getMaxPduLength()));const e=new r(this.association).write();_.info(`${this.logId} -> Association accept:${Q}${this.association.toString()}`),this._sendPdu(e)}sendAssociationReject(e,t,s){const n=new o(e,t,s),i=n.write();_.info(`${this.logId} -> Association reject ${n.toString()}`),this._sendPdu(i)}sendAssociationReleaseRequest(){const e=(new d).write();_.info(`${this.logId} -> Association release request`),this._sendPdu(e)}sendAssociationReleaseResponse(){const e=(new c).write();_.info(`${this.logId} -> Association release response`),this._sendPdu(e)}sendRequests(e){const t=Array.isArray(e)?e:[e];this.requests.push(...t),this._sendNextRequests()}sendCancel(e){if(!this.association)return void _.error(`There is no association in which to cancel request ${e.toString()}. Skipping...`);const t=R.fromRequest(e),s=this.association.getAcceptedPresentationContextFromRequest(t);if(!s)return void _.error(`Could not find an accepted presentation context to cancel request ${e.toString()}. Skipping...`);const n={context:s,command:t};this._sendDimse(n)}sendAbort(e,t){if(!this.association)return void _.error("There is no association to perform abort. Skipping...");const s=new i(e,t),n=s.write();_.info(`${this.logId} -> Abort ${s.toString()}`),this._sendPdu(n)}getStatistics(){return this.statistics}_getNextMessageId(){return++this.messageId%65536}_sendPdu(e){try{const t=e.writePdu();this.socket.write(t),this.statistics.addBytesSent(t.length)}catch(t){_.error(`${this.logId} -> Error sending PDU [type: ${e.getType()}]: ${t.message}`),this.emit("networkError",t)}}_sendNextRequests(){const e=()=>{const t=this.requests.shift();if(!t)return void this.emit("done");const s=this.association.getAcceptedPresentationContextFromRequest(t);if(s){t instanceof A&&t.loadFullDatasetIfNeeded(),t.setMessageId(this._getNextMessageId()),this.pending.push(t);const n={context:s,command:t};n.command.on("done",(()=>{e()})),this._sendDimse(n)}else _.error(`Could not find an accepted presentation context for request ${t.toString()}. Skipping...`),e()};e()}_sendDimse(e){try{const t=e.command.getDataset(),s=this.association.getPresentationContext(e.context.getPresentationContextId()).getAcceptedTransferSyntaxUid();if(t&&s!==t.getTransferSyntaxUid()){if(!p.includes(s)||!p.includes(t.getTransferSyntaxUid()))return _.error(`A transfer syntax transcoding from ${t.getTransferSyntaxUid()} to ${s} is currently not supported. Skipping...`),void e.command.raiseDoneEvent();t.setTransferSyntaxUid(s)}this._sendPDataTF(e.command,e.context.getPresentationContextId(),this.association.getMaxPduLength())}catch(e){_.error(`${this.logId} -> Error sending DIMSE: ${e.message}`),this.emit("networkError",e)}}_sendPDataTF(e,t,s){const n=4194304;s=0===s?n:Math.min(s,n);const i=e.getCommandDataset().getDenaturalizedCommandDataset();_.info(`${this.logId} -> ${e.toString({includeCommandDataset:this.logCommandDatasets,includeDataset:this.logDatasets})} [pc: ${t}]`);const r=new u,o=new h(t,i,!0,!0);r.addPdv(o);const a=r.write().writePdu();this.socket.write(a),this.statistics.addBytesSent(a.length);const c=e.getDataset();if(c){const e=c.getDenaturalizedDataset(this.datasetWriteOptions,this.datasetNameMap),n=[],i=e.length,r=s-6;let o=0;for(;o<i;)n.push(e.slice(o,o+=r));for(let e=0;e<n.length;e++){const s=n.length===e+1,i=new h(t,n[e],!1,s),r=new u;r.addPdv(i);const o=r.write().writePdu();this.socket.write(o),this.statistics.addBytesSent(o.length)}}}_processPdu(e){const t=new m(e);try{switch(t.readPdu(),t.getType()){case 1:this.association=new n,new a(this.association).read(t),this.logId=this.association.getCallingAeTitle(),_.info(`${this.logId} <- Association request:${Q}${this.association.toString()}`),this.emit("associationRequested",this.association);break;case 2:new r(this.association).read(t),this.logId=this.association.getCalledAeTitle(),_.info(`${this.logId} <- Association accept:${Q}${this.association.toString()}`),this.emit("associationAccepted",this.association);break;case 3:{const e=new o;e.read(t),_.info(`${this.logId} <- Association reject ${e.toString()}`),this.emit("associationRejected",{result:e.getResult(),source:e.getSource(),reason:e.getReason()});break}case 4:{const e=new u;e.read(t),this._processPDataTf(e);break}case 5:(new d).read(t),_.info(`${this.logId} <- Association release request`),this.emit("associationReleaseRequested");break;case 6:(new c).read(t),_.info(`${this.logId} <- Association release response`),this.emit("associationReleaseResponse");break;case 7:{const e=new i;e.read(t),_.info(`${this.logId} <- Association abort ${e.toString()}`),this.emit("abort",{source:e.getSource(),reason:e.getReason()});break}case 255:break;default:throw new Error(`Unknown PDU type: ${t.getType()}`)}}catch(e){_.error(`${this.logId} -> Error reading PDU [type: ${t.getType()}]: ${e.message}`),this.emit("networkError",e)}}_processPDataTf(e){try{e.getPdvs().forEach((e=>{this.dimseBuffer||(this.dimseBuffer=z.fromOptions({encoding:"ascii"})),this.dimseBuffer.writeBuffer(e.getValue());const t=this.association.getPresentationContext(e.getPresentationContextId());if(e.isLastFragment())if(e.isCommand()){const s=new w(new j(this.dimseBuffer.toBuffer()));switch(s.getCommandFieldType()){case g.CEchoRequest:this.dimse=Object.assign(new f,s);break;case g.CEchoResponse:this.dimse=Object.assign(new y,s);break;case g.CFindRequest:this.dimse=Object.assign(new S,s);break;case g.CFindResponse:this.dimse=Object.assign(new I,s);break;case g.CStoreRequest:this.dimse=Object.assign(new A,s);break;case g.CStoreResponse:this.dimse=Object.assign(new U,s);break;case g.CMoveRequest:this.dimse=Object.assign(new v,s);break;case g.CMoveResponse:this.dimse=Object.assign(new x,s);break;case g.CGetRequest:this.dimse=Object.assign(new C,s);break;case g.CGetResponse:this.dimse=Object.assign(new P,s);break;case g.NCreateRequest:this.dimse=Object.assign(new E,s);break;case g.NCreateResponse:this.dimse=Object.assign(new T,s);break;case g.NActionRequest:this.dimse=Object.assign(new q,s);break;case g.NActionResponse:this.dimse=Object.assign(new D,s);break;case g.NDeleteRequest:this.dimse=Object.assign(new b,s);break;case g.NDeleteResponse:this.dimse=Object.assign(new O,s);break;case g.NEventReportRequest:this.dimse=Object.assign(new N,s);break;case g.NEventReportResponse:this.dimse=Object.assign(new B,s);break;case g.NGetRequest:this.dimse=Object.assign(new M,s);break;case g.NGetResponse:this.dimse=Object.assign(new L,s);break;case g.NSetRequest:this.dimse=Object.assign(new F,s);break;case g.NSetResponse:this.dimse=Object.assign(new k,s);break;case g.CCancelRequest:this.dimse=Object.assign(new R,s);break;default:this.dimse=s}if(_.info(`${this.logId} <- ${this.dimse.toString({includeCommandDataset:this.logCommandDatasets,includeDataset:this.logDatasets})} [pc: ${e.getPresentationContextId()}]`),!this.dimse.hasDataset())return this._performDimse(t,this.dimse),void(this.dimse=void 0);this.dimseBuffer=void 0}else{const e=new j(this.dimseBuffer.toBuffer(),t.getAcceptedTransferSyntaxUid(),this.datasetReadOptions);this.dimse.setDataset(e),this._performDimse(t,this.dimse),this.dimseBuffer=void 0,this.dimse=void 0}}))}catch(e){_.error(`${this.logId} -> Error reading DIMSE: ${e.message}`),this.emit("networkError",e)}}_performDimse(e,t){if(t instanceof $){const e=Object.assign(Object.create(Object.getPrototypeOf(t)),t),s=this.pending.find((e=>e.getMessageId()===t.getMessageIdBeingRespondedTo()));s&&(s.raiseResponseEvent(e),e.getStatus()!==l.Pending&&s.raiseDoneEvent())}else t.getCommandFieldType()===g.CEchoRequest?this.emit("cEchoRequest",t,(t=>{this._sendDimse({context:e,command:t})})):t.getCommandFieldType()===g.CFindRequest?this.emit("cFindRequest",t,(t=>{(Array.isArray(t)?t:[t]).forEach((t=>{this._sendDimse({context:e,command:t})}))})):t.getCommandFieldType()===g.CStoreRequest?this.emit("cStoreRequest",t,(t=>{this._sendDimse({context:e,command:t})})):t.getCommandFieldType()===g.CMoveRequest?this.emit("cMoveRequest",t,(t=>{(Array.isArray(t)?t:[t]).forEach((t=>{this._sendDimse({context:e,command:t})}))})):t.getCommandFieldType()===g.CGetRequest?this.emit("cGetRequest",t,(t=>{(Array.isArray(t)?t:[t]).forEach((t=>{this._sendDimse({context:e,command:t})}))})):t.getCommandFieldType()===g.NCreateRequest?this.emit("nCreateRequest",t,(t=>{this._sendDimse({context:e,command:t})})):t.getCommandFieldType()===g.NActionRequest?this.emit("nActionRequest",t,(t=>{this._sendDimse({context:e,command:t})})):t.getCommandFieldType()===g.NDeleteRequest?this.emit("nDeleteRequest",t,(t=>{this._sendDimse({context:e,command:t})})):t.getCommandFieldType()===g.NEventReportRequest?this.emit("nEventReportRequest",t,(t=>{this._sendDimse({context:e,command:t})})):t.getCommandFieldType()===g.NGetRequest?this.emit("nGetRequest",t,(t=>{this._sendDimse({context:e,command:t})})):t.getCommandFieldType()===g.NSetRequest?this.emit("nSetRequest",t,(t=>{this._sendDimse({context:e,command:t})})):t.getCommandFieldType()===g.CCancelRequest&&this.emit("cCancelRequest",t)}_wrapSocket(){this.socket.setTimeout(this.connectTimeout),this.socket.on("connect",(()=>{this.connected=!0,this.connectedTime=Date.now(),this.emit("connect")}));const e=new J;e.on("pdu",(e=>{this.lastPduTime=Date.now(),this._processPdu(e)})),this.socket.on("data",(t=>{e.accumulate(t),this.statistics.addBytesReceived(t.length)})),this.socket.on("error",(e=>{this._reset();const t=`${this.logId} -> Connection error: ${e.message}`;_.error(t),this.emit("networkError",new Error(t))})),this.socket.on("timeout",(()=>{this._reset();const e=`${this.logId} -> Connection timeout`;_.error(e),this.emit("networkError",new Error(e))})),this.socket.on("close",(()=>{this._reset(),_.info(`${this.logId} -> Connection closed`),this.emit("close")})),this.timeoutIntervalId=setInterval((()=>{const e=Date.now();let t,s=!1;this.connected&&!this.lastPduTime&&e-this.connectedTime>=this.associationTimeout?(t=`${this.logId} -> Exceeded association timeout (${this.associationTimeout}), closing connection...`,s=!0):this.connected&&this.lastPduTime&&e-this.lastPduTime>=this.pduTimeout&&(t=`${this.logId} -> Exceeded PDU timeout (${this.pduTimeout}), closing connection...`,s=!0),s&&(this.sendAbort(),this._reset(),_.error(t),this.emit("networkError",new Error(`Connection timeout: ${t}`)))}),1e3)}_reset(){this.connected=!1,this.lastPduTime=void 0,this.connectedTime=void 0,this.timeoutIntervalId&&(clearInterval(this.timeoutIntervalId),this.timeoutIntervalId=void 0)}}},942:(e,t,s)=>{const{AbortReason:n,AbortSource:i,RejectReason:r,RejectResult:o,RejectSource:a,TransferSyntax:c}=s(492),{SmartBuffer:d}=s(766),{EOL:u}=s(857);class h{constructor(e){if(this.m16=[],this.m32=[],Buffer.isBuffer(e))return this.buffer=d.fromBuffer(e,"ascii"),void(this.type=this.buffer.readUInt8());this.buffer=d.fromOptions({encoding:"ascii"}),this.type=e}getType(){return this.type}getLength(){return this.buffer.length}reset(){this.buffer.readOffset=0,this.buffer.writeOffset=0}readPdu(){this.buffer.readUInt8();const e=this.buffer.readUInt32BE(),t=this.buffer.readBuffer(e);this.buffer=d.fromBuffer(t,"ascii")}writePdu(){const e=d.fromOptions({encoding:"ascii"}),t=this.getLength();return e.writeUInt8(this.type),e.writeUInt8(0),e.writeUInt8((4278190080&t)>>24),e.writeUInt8((16711680&t)>>16),e.writeUInt8((65280&t)>>8),e.writeUInt8(255&t),e.writeBuffer(this.buffer.toBuffer()),e.toBuffer()}checkOffset(e,t){const s=this.buffer.readOffset,n=this.buffer.length;if(s+e>n)throw new Error(`${this.toString()} [length: ${n}, offset: ${s}, bytes: ${e}, field: ${t}] Requested offset out of range!`)}readByte(e){return this.checkOffset(1,e),this.buffer.readUInt8()}readBytes(e,t){return this.checkOffset(t,e),this.buffer.readBuffer(t)}readUInt16(e){return this.checkOffset(2,e),this.buffer.readUInt16BE()}readUInt32(e){return this.checkOffset(4,e),this.buffer.readUInt32BE()}readString(e,t){const s=this.readBytes(e,t);return this._trim(String.fromCharCode.apply(String,s),[" ","\0"])}skipBytes(e,t){this.checkOffset(t,e),this.buffer.readOffset+=t}writeByte(e,t){this.buffer.writeUInt8(t)}writeByteMultiple(e,t,s){for(let n=0;n<s;n++)this.writeByte(e,t)}writeBytes(e,t){this.buffer.writeBuffer(t)}writeUInt16(e,t){this.buffer.writeUInt16BE(t)}writeUInt32(e,t){this.buffer.writeUInt32BE(t)}writeString(e,t){for(let e=0,s=t.length;e<s;++e)this.buffer.writeUInt8(t.charCodeAt(e))}writeStringWithPadding(e,t,s,n){this.writeString(e,t.padEnd(s,n))}markLength16(e){this.m16.push(this.buffer.writeOffset),this.buffer.writeUInt16BE(0)}writeLength16(){const e=this.m16.pop(),t=this.buffer.writeOffset;this.buffer.writeOffset=e,this.buffer.writeUInt16BE(t-e-2),this.buffer.writeOffset=t}markLength32(e){this.m32.push(this.buffer.writeOffset),this.buffer.writeUInt32BE(0)}writeLength32(){const e=this.m32.pop(),t=this.buffer.writeOffset;this.buffer.writeOffset=e,this.buffer.writeUInt32BE(t-e-4),this.buffer.writeOffset=t}toString(){return`(PDU) [type: ${this.getType()}, length: ${this.getLength()}]`}_trim(e,t){let s=0,n=e.length;for(;s<n&&t.indexOf(e[s])>=0;)++s;for(;n>s&&t.indexOf(e[n-1])>=0;)--n;return s>0||n<e.length?e.substring(s,n):e}}class m{constructor(e,t,s,n){this.pcId=e,this.value=t,this.command=s,this.last=n}getPresentationContextId(){return this.pcId}getValue(){return this.value}isCommand(){return this.command}isLastFragment(){return this.last}getLength(){return this.value.length+6}write(e){const t=(this.last?2:0)+(this.command?1:0);e.markLength32("PDV-Length"),e.writeByte("Presentation Context ID",this.pcId),e.writeByte("Message Control Header",t),e.writeBytes("PDV Value",this.value),e.writeLength32()}read(e){const t=e.readUInt32("PDV-Length");this.pcId=e.readByte("Presentation Context ID");const s=e.readByte("Message Control Header");return this.value=e.readBytes("PDV Value",t-2),this.command=0!=(1&s),this.last=0!=(2&s),t+4}toString(){return`(PDV) [pc: ${this.getPresentationContextId()}, command: ${this.isCommand()}, last: ${this.isLastFragment()}, length: ${this.getLength()}]`}}e.exports={AAbort:class{constructor(e,t){this.source=e||i.ServiceUser,this.reason=t||n.NotSpecified}getSource(){return this.source}getReason(){return this.reason}write(){const e=new h(7);return e.writeByte("Reserved",0),e.writeByte("Reserved",0),e.writeByte("Source",this.source),e.writeByte("Reason",this.reason),e}read(e){e.readByte("Reserved"),e.readByte("Reserved"),this.source=e.readByte("Source"),this.reason=e.readByte("Reason")}toString(){return`(A-ABORT) [source: ${this._sourceToString(this.getSource())}, reason: ${this._reasonToString(this.getReason())}]`}_sourceToString(e){switch(e){case i.ServiceUser:return"Service user";case i.Unknown:return"Unknown";case i.ServiceProvider:return"Service provider";default:return`${e}`}}_reasonToString(e){switch(e){case n.NotSpecified:return"Not specified";case n.UnrecognizedPdu:return"Unrecognized PDU";case n.UnexpectedPdu:return"Unexpected PDU";case n.UnrecognizedPduParameter:return"Unrecognized PDU parameter";case n.UnexpectedPduParameter:return"Unexpected PDU parameter";case n.InvalidPduParameter:return"Invalid PDU parameter";default:return`${e}`}}},AAssociateAC:class{constructor(e){this.association=e}getAssociation(){return this.association}write(){const e=new h(2);return e.writeUInt16("Version",1),e.writeByteMultiple("Reserved",0,2),e.writeStringWithPadding("Called AE",this.association.getCalledAeTitle(),16," "),e.writeStringWithPadding("Calling AE",this.association.getCallingAeTitle(),16," "),e.writeByteMultiple("Reserved",0,32),e.writeByte("Item-Type",16),e.writeByte("Reserved",0),e.markLength16("Item-Length"),e.writeString("Application Context Name",this.association.getApplicationContextName()),e.writeLength16(),this.association.getPresentationContexts().forEach((t=>{const s=this.association.getPresentationContext(t.id);e.writeByte("Item-Type",33),e.writeByte("Reserved",0),e.markLength16("Item-Length"),e.writeByte("Presentation Context ID",s.getPresentationContextId()),e.writeByte("Reserved",0),e.writeByte("Result",s.getResult()),e.writeByte("Reserved",0),e.writeByte("Item-Type",64),e.writeByte("Reserved",0),e.markLength16("Item-Length"),e.writeString("Transfer Syntax UID",s.getAcceptedTransferSyntaxUid()||c.ImplicitVRLittleEndian),e.writeLength16(),e.writeLength16()})),e.writeByte("Item-Type",80),e.writeByte("Reserved",0),e.markLength16("Item-Length"),e.writeByte("Item-Type",81),e.writeByte("Reserved",0),e.writeUInt16("Item-Length",4),e.writeUInt32("Max PDU Length",this.association.getMaxPduLength()),e.writeByte("Item-Type",82),e.writeByte("Reserved",0),e.markLength16("Item-Length"),e.writeString("Implementation Class UID",this.association.getImplementationClassUid()),e.writeLength16(),!this.association.getNegotiateAsyncOps()||1===this.association.getMaxAsyncOpsInvoked()&&1===this.association.getMaxAsyncOpsPerformed()||(e.writeByte("Item-Type",83),e.writeByte("Reserved",0),e.writeUInt16("Item-Length",4),e.writeUInt16("Asynchronous Operations Invoked",this.association.getMaxAsyncOpsInvoked()),e.writeUInt16("Asynchronous Operations Performed",this.association.getMaxAsyncOpsPerformed())),e.writeByte("Item-Type",85),e.writeByte("Reserved",0),e.markLength16("Item-Length"),e.writeString("Implementation Version",this.association.getImplementationVersion()),e.writeLength16(),this.association.getNegotiateUserIdentityServerResponse()&&(e.writeByte("Item-Type",89),e.writeByte("Reserved",0),e.markLength16("Item-Length"),e.markLength16("Server Response-Length"),e.writeString("Server Response",this.association.getUserIdentityServerResponse()),e.writeLength16(),e.writeLength16()),e.writeLength16(),e}read(e){let t=e.getLength()-6;for(e.readUInt16("Version"),e.skipBytes("Reserved",2),e.skipBytes("Reserved",16),e.skipBytes("Reserved",16),e.skipBytes("Reserved",32),t-=68;t>0;){const s=e.readByte("Item-Type");if(t-=1,16===s){e.skipBytes("Reserved",1);const s=e.readUInt16("Item-Length");e.skipBytes("Value",s),t-=3+s}else if(33===s){e.readByte("Reserved");let s=e.readUInt16("Presentation Context Item-Length");const n=e.readByte("Presentation Context ID");e.readByte("Reserved");const i=e.readByte("Presentation Context Result/Reason");if(e.readByte("Reserved"),t-=s+3,s-=4,0===i){e.readByte("Presentation Context Item-Type (0x40)"),e.readByte("Reserved");const t=e.readUInt16("Presentation Context Item-Length"),r=e.readString("Presentation Context Syntax UID",t);s-=t+4,this.association.getPresentationContext(n).setResult(i,r)}else e.skipBytes("Rejected Presentation Context",s),this.association.getPresentationContext(n).setResult(i)}else if(80===s){e.readByte("Reserved");let s=e.readUInt16("User Information Item-Length");for(t-=s+3;s>0;){const t=e.readByte("User Item-Type");e.readByte("Reserved");const n=e.readUInt16("User Item-Length");if(s-=n+4,81===t)this.association.setMaxPduLength(e.readUInt32("Max PDU Length"));else if(82===t)this.association.setImplementationClassUid(e.readString("Implementation Class UID",n));else if(83===t)this.association.setMaxAsyncOpsInvoked(e.readUInt16("Asynchronous Operations Invoked")),this.association.setMaxAsyncOpsPerformed(e.readUInt16("Asynchronous Operations Performed")),this.association.setNegotiateAsyncOps(1!==this.association.getMaxAsyncOpsInvoked()||1!==this.association.getMaxAsyncOpsPerformed());else if(85===t)this.association.setImplementationVersion(e.readString("Implementation Version",n));else if(89===t){const t=e.readUInt16("Server Response-Length");this.association.setUserIdentityServerResponse(e.readString("Server Response",t)),this.association.setNegotiateUserIdentityServerResponse(!0)}else e.skipBytes("User Item Value",n)}}else{e.skipBytes("Reserved",1);const s=e.readUInt16("User Item-Length");e.skipBytes("Unknown User Item",s),t-=s+3}}}toString(){return`(A-ASSOCIATE-AC)${u}${this.association.toString()}`}},AAssociateRJ:class{constructor(e,t,s){this.result=e||o.Permanent,this.source=t||a.ServiceUser,this.reason=s||r.NoReasonGiven}getResult(){return this.result}getSource(){return this.source}getReason(){return this.reason}write(){const e=new h(3);return e.writeByte("Reserved",0),e.writeByte("Result",this.result),e.writeByte("Source",this.source),e.writeByte("Reason",this.reason),e}read(e){e.readByte("Reserved"),this.result=e.readByte("Result"),this.source=e.readByte("Source"),this.reason=e.readByte("Reason")}toString(){return`(A-ASSOCIATE-RJ) [result: ${this._resultToString(this.getResult())}, source: ${this._sourceToString(this.getSource())}, reason: ${this._reasonToString(this.getSource(),this.getReason())}]`}_resultToString(e){switch(e){case o.Permanent:return"Permanent";case o.Transient:return"Transient";default:return`${e}`}}_sourceToString(e){switch(e){case a.ServiceUser:return"Service user";case a.ServiceProviderAcse:return"Service provider (ACSE)";case a.ServiceProviderPresentation:return"Service provider (Presentation)";default:return`${e}`}}_reasonToString(e,t){if(e===a.ServiceUser)switch(t){case r.NoReasonGiven:return"No reason given";case r.ApplicationContextNotSupported:return"Application context name not supported";case r.CallingAeNotRecognized:return"Calling AE title not recognized";case r.CalledAeNotRecognized:return"Called AE title not recognized";default:return`${t}`}else if(e===a.ServiceProviderAcse)switch(t){case r.NoReasonGiven:return"No reason given";case r.ProtocolVersionNotSupported:return"Protocol version not supported";default:return`${t}`}else if(e===a.ServiceProviderPresentation)switch(t){case r.TemporaryCongestion:return"Temporary congestion";case r.LocalLimitExceeded:return"Local limit exceeded";default:return`${t}`}return`${t}`}},AAssociateRQ:class{constructor(e){this.association=e}getAssociation(){return this.association}write(){const e=new h(1);return e.writeUInt16("Version",1),e.writeByteMultiple("Reserved",0,2),e.writeStringWithPadding("Called AE",this.association.getCalledAeTitle(),16," "),e.writeStringWithPadding("Calling AE",this.association.getCallingAeTitle(),16," "),e.writeByteMultiple("Reserved",0,32),e.writeByte("Item-Type",16),e.writeByte("Reserved",0),e.markLength16("Item-Length"),e.writeString("Application Context Name",this.association.getApplicationContextName()),e.writeLength16(),this.association.getPresentationContexts().forEach((t=>{const s=this.association.getPresentationContext(t.id);e.writeByte("Item-Type",32),e.writeByte("Reserved",0),e.markLength16("Item-Length"),e.writeByte("Presentation Context ID",s.getPresentationContextId()),e.writeByteMultiple("Reserved",0,3),e.writeByte("Item-Type",48),e.writeByte("Reserved",0),e.markLength16("Item-Length"),e.writeString("Abstract Syntax UID",s.getAbstractSyntaxUid()),e.writeLength16(),s.getTransferSyntaxUids().forEach((t=>{e.writeByte("Item-Type",64),e.writeByte("Reserved",0),e.markLength16("Item-Length"),e.writeString("Transfer Syntax UID",t),e.writeLength16()})),e.writeLength16()})),e.writeByte("Item-Type",80),e.writeByte("Reserved",0),e.markLength16("Item-Length"),e.writeByte("Item-Type",81),e.writeByte("Reserved",0),e.writeUInt16("Item-Length",4),e.writeUInt32("Max PDU Length",this.association.getMaxPduLength()),e.writeByte("Item-Type",82),e.writeByte("Reserved",0),e.markLength16("Item-Length"),e.writeString("Implementation Class UID",this.association.getImplementationClassUid()),e.writeLength16(),!this.association.getNegotiateAsyncOps()||1===this.association.getMaxAsyncOpsInvoked()&&1===this.association.getMaxAsyncOpsPerformed()||(e.writeByte("Item-Type",83),e.writeByte("Reserved",0),e.writeUInt16("Item-Length",4),e.writeUInt16("Asynchronous Operations Invoked",this.association.getMaxAsyncOpsInvoked()),e.writeUInt16("Asynchronous Operations Performed",this.association.getMaxAsyncOpsPerformed())),e.writeByte("Item-Type",85),e.writeByte("Reserved",0),e.markLength16("Item-Length"),e.writeString("Implementation Version",this.association.getImplementationVersion()),e.writeLength16(),this.association.getNegotiateUserIdentity()&&(e.writeByte("Item-Type",88),e.writeByte("Reserved",0),e.markLength16("Item-Length"),e.writeByte("User Identity Type",this.association.getUserIdentityType()),e.writeByte("Positive Response Requested",this.association.getUserIdentityPositiveResponseRequested()),e.markLength16("User Identity Primary Field-Length"),e.writeString("User Identity Primary Field",this.association.getUserIdentityPrimaryField()),e.writeLength16(),e.markLength16("User Identity Secondary Field-Length"),e.writeString("User Identity Secondary Field",this.association.getUserIdentitySecondaryField()),e.writeLength16(),e.writeLength16()),e.writeLength16(),e}read(e){let t=e.getLength()-6;for(e.readUInt16("Version"),e.skipBytes("Reserved",2),this.association.setCalledAeTitle(e.readString("Called AE",16)),this.association.setCallingAeTitle(e.readString("Calling AE",16)),e.skipBytes("Reserved",32),t-=68;t>0;){const s=e.readByte("Item-Type");e.skipBytes("Reserved",1);let n=e.readUInt16("Item-Length");if(t-=4+n,16===s)e.skipBytes("Application Context",n);else if(32===s){const t=e.readByte("Presentation Context ID");for(e.skipBytes("Reserved",3),n-=4;n>0;){const s=e.readByte("Presentation Context Item-Type");e.skipBytes("Reserved",1);const i=e.readUInt16("Presentation Context Item-Length"),r=e.readString("Presentation Context Syntax UID",i);48===s?this.association.addPresentationContext(r,t):64===s&&this.association.addTransferSyntaxToPresentationContext(t,r),n-=4+i}}else if(80===s)for(;n>0;){const t=e.readByte("User Information Item-Type");e.skipBytes("Reserved",1);const s=e.readUInt16("User Information Item-Length");if(n-=4+s,81==t)this.association.setMaxPduLength(e.readUInt32("Max PDU Length"));else if(82===t)this.association.setImplementationClassUid(e.readString("Implementation Class UID",s));else if(83===t)this.association.setMaxAsyncOpsInvoked(e.readUInt16("Asynchronous Operations Invoked")),this.association.setMaxAsyncOpsPerformed(e.readUInt16("Asynchronous Operations Performed")),this.association.setNegotiateAsyncOps(1!==this.association.getMaxAsyncOpsInvoked()||1!==this.association.getMaxAsyncOpsPerformed());else if(85===t)this.association.setImplementationVersion(e.readString("Implementation Version",s));else if(88===t){this.association.setUserIdentityType(e.readByte("User Identity Type")),this.association.setUserIdentityPositiveResponseRequested(1===e.readByte("Positive Response Requested"));const t=e.readUInt16("User Identity Primary Field-Length");this.association.setUserIdentityPrimaryField(e.readString("User Identity Primary Field",t));const s=e.readUInt16("User Identity Secondary Field-Length");this.association.setUserIdentitySecondaryField(e.readString("User Identity Secondary Field",s)),this.association.setNegotiateUserIdentity(!0)}else e.skipBytes("Unhandled User Item",s)}}}toString(){return`(A-ASSOCIATE-RQ)${u}${this.association.toString()}`}},AReleaseRP:class{constructor(){}write(){const e=new h(6);return e.writeUInt32("Reserved",0),e}read(e){e.readUInt32("Reserved")}toString(){return"(A-RELEASE-RP)"}},AReleaseRQ:class{constructor(){}write(){const e=new h(5);return e.writeUInt32("Reserved",0),e}read(e){e.readUInt32("Reserved")}toString(){return"(A-RELEASE-RQ)"}},PDataTF:class{constructor(){this.pdvs=[]}getPdvs(){return this.pdvs}getPdvCount(){return this.pdvs.length}addPdv(e){return this.pdvs.push(e)}clearPdvs(){this.pdvs.length=0}getLengthOfPdvs(){let e=0;return this.pdvs.forEach((t=>{e+=t.getLength()})),e}write(){const e=new h(4);return this.pdvs.forEach((t=>{t.write(e)})),e}read(e){const t=e.getLength();let s=0;for(;s<t;){const t=new m;s+=t.read(e),this.pdvs.push(t)}}toString(){return`(P-DATA-TF) [PDV count: ${this.getPdvCount()}, PDV length: ${this.getLengthOfPdvs()}]`}},Pdv:m,RawPdu:h}},538:(e,t,s)=>{const{CEchoResponse:n,CFindResponse:i,CGetResponse:r,CMoveResponse:o,CStoreResponse:a,NActionResponse:c,NCreateResponse:d,NDeleteResponse:u,NEventReportResponse:h,NGetResponse:m,NSetResponse:g}=s(940),l=s(371),p=s(906),R=s(547),f=s(733),y=s(278),S=s(756);e.exports={Scp:class extends l{constructor(e,t){super(e,t),this.on("associationRequested",(e=>{this.associationRequested(e)})),this.on("associationReleaseRequested",(()=>{this.associationReleaseRequested()})),this.on("cEchoRequest",((e,t)=>{this.cEchoRequest(e,t)})),this.on("cFindRequest",((e,t)=>{this.cFindRequest(e,t)})),this.on("cStoreRequest",((e,t)=>{this.cStoreRequest(e,t)})),this.on("cMoveRequest",((e,t)=>{this.cMoveRequest(e,t)})),this.on("cGetRequest",((e,t)=>{this.cGetRequest(e,t)})),this.on("nCreateRequest",((e,t)=>{this.nCreateRequest(e,t)})),this.on("nActionRequest",((e,t)=>{this.nActionRequest(e,t)})),this.on("nDeleteRequest",((e,t)=>{this.nDeleteRequest(e,t)})),this.on("nEventReportRequest",((e,t)=>{this.nEventReportRequest(e,t)})),this.on("nGetRequest",((e,t)=>{this.nGetRequest(e,t)})),this.on("nSetRequest",((e,t)=>{this.nSetRequest(e,t)})),this.on("cCancelRequest",(e=>{this.cCancelRequest(e)})),this.on("abort",(({source:e,reason:t})=>{this.abort(e,t)}))}associationRequested(e){R.error("associationRequested method must be implemented"),this.sendAssociationReject()}associationReleaseRequested(){R.error("associationReleaseRequested method must be implemented"),this.sendAssociationReleaseResponse()}cEchoRequest(e,t){R.error("cEchoRequest method must be implemented"),t(n.fromRequest(e))}cFindRequest(e,t){R.error("cFindRequest method must be implemented"),t(i.fromRequest(e))}cStoreRequest(e,t){R.error("cStoreRequest method must be implemented"),t(a.fromRequest(e))}cMoveRequest(e,t){R.error("cMoveRequest method must be implemented"),t(o.fromRequest(e))}cGetRequest(e,t){R.error("cGetRequest method must be implemented"),t(r.fromRequest(e))}nCreateRequest(e,t){R.error("nCreateRequest method must be implemented"),t(d.fromRequest(e))}nActionRequest(e,t){R.error("nActionRequest method must be implemented"),t(c.fromRequest(e))}nDeleteRequest(e,t){R.error("nDeleteRequest method must be implemented"),t(u.fromRequest(e))}nEventReportRequest(e,t){R.error("nEventReportRequest method must be implemented"),t(h.fromRequest(e))}nGetRequest(e,t){R.error("nGetRequest method must be implemented"),t(m.fromRequest(e))}nSetRequest(e,t){R.error("nSetRequest method must be implemented"),t(g.fromRequest(e))}cCancelRequest(e){R.error("cCancelRequest method must be implemented")}abort(e,t){R.error("abort method must be implemented")}},Server:class extends f{constructor(e){super(),this.scp={class:e},this.server=void 0,this.clients=[],this.statistics=new p}listen(e,t){let s={};(t=t||{}).securityOptions&&(s={key:t.securityOptions.key,cert:t.securityOptions.cert,ca:t.securityOptions.ca,requestCert:t.securityOptions.requestCert,rejectUnauthorized:t.securityOptions.rejectUnauthorized,minVersion:t.securityOptions.minVersion,maxVersion:t.securityOptions.maxVersion,ciphers:t.securityOptions.ciphers,SNICallback:t.securityOptions.SNICallback});const n=t.securityOptions?S:y;this.server=n.createServer(s,(e=>{R.info(`Client connecting from ${e.remoteAddress}:${e.remotePort} ${t.securityOptions?e.authorized?"(Authorized)":"(Unauthorized)":""}`);const s=new this.scp.class(e,t);s.connected=!0,s.on("close",(()=>{this.statistics.addFromOtherStatistics(s.getStatistics())})),this.clients.push(s),this.clients=this.clients.filter((e=>e.connected))})),this.server.on("listening",(()=>{R.info(`DICOM server listening on port ${e} ${t.securityOptions?"(TLS)":""}`),this.emit("listening")})),this.server.on("error",(e=>{const t=`Server error: ${e.message}`;R.error(t),this.emit("networkError",e)})),this.server.listen(e)}getStatistics(){return this.statistics}close(){this.server&&this.server.listening&&this.server.close(),this.clients.forEach((e=>e.socket.destroy())),this.clients=[]}}}},906:e=>{e.exports=class{constructor(){this.bytesReceived=0,this.bytesSent=0}getBytesReceived(){return this.bytesReceived}getBytesSent(){return this.bytesSent}addBytesReceived(e){this.bytesReceived+=e}addBytesSent(e){this.bytesSent+=e}addFromOtherStatistics(e){this.addBytesReceived(e.getBytesReceived()),this.addBytesSent(e.getBytesSent())}reset(){this.bytesReceived=0,this.bytesSent=0}toString(){return`Sent: ${this._formatBytes(this.getBytesSent())}, Received: ${this._formatBytes(this.getBytesReceived())}`}_formatBytes(e){if(void 0===e||0===e)return"0 Bytes";const t=Math.floor(Math.log(e)/Math.log(1024));return`${parseFloat((e/Math.pow(1024,t)).toFixed(3))} ${["Bytes","KB","MB","GB","TB","PB"][t]}`}}},237:(e,t,s)=>{const{Association:n,PresentationContext:i}=s(570),{Scp:r,Server:o}=s(538),{CCancelRequest:a,CEchoRequest:c,CEchoResponse:d,CFindRequest:u,CFindResponse:h,CGetRequest:m,CGetResponse:g,CMoveRequest:l,CMoveResponse:p,CStoreRequest:R,CStoreResponse:f,NActionRequest:y,NActionResponse:S,NCreateRequest:I,NCreateResponse:C,NDeleteRequest:P,NDeleteResponse:v,NEventReportRequest:x,NEventReportResponse:w,NGetRequest:A,NGetResponse:U,NSetRequest:q,NSetResponse:D}=s(940),{AbortReason:E,AbortSource:T,CommandFieldType:b,PresentationContextResult:O,Priority:N,RejectReason:B,RejectResult:M,RejectSource:L,SopClass:F,Status:k,StorageClass:$,TransferSyntax:j,Uid:V,UserIdentityType:G}=s(492),_=s(422),z=s(825),Q=s(139),W=s(906),J={association:{Association:n,PresentationContext:i},Client:_,constants:{AbortReason:E,AbortSource:T,CommandFieldType:b,PresentationContextResult:O,Priority:N,RejectReason:B,RejectResult:M,RejectSource:L,SopClass:F,Status:k,StorageClass:$,TransferSyntax:j,Uid:V,UserIdentityType:G},Dataset:z,Implementation:Q,log:s(547),requests:{CCancelRequest:a,CEchoRequest:c,CFindRequest:u,CGetRequest:m,CMoveRequest:l,CStoreRequest:R,NActionRequest:y,NCreateRequest:I,NDeleteRequest:P,NEventReportRequest:x,NGetRequest:A,NSetRequest:q},responses:{CEchoResponse:d,CFindResponse:h,CGetResponse:g,CMoveResponse:p,CStoreResponse:f,NActionResponse:S,NCreateResponse:C,NDeleteResponse:v,NEventReportResponse:w,NGetResponse:U,NSetResponse:D},Scp:r,Server:o,Statistics:W,version:s(837)};e.exports=J},547:(e,t,s)=>{const{createLogger:n,format:i,transports:r}=s(688),{combine:o,printf:a,timestamp:c}=i,d=n({format:o(c(),a((({level:e,message:t,timestamp:s})=>`${s} -- ${e.toUpperCase()} -- ${t}`))),transports:[new r.Console]});e.exports=d},837:e=>{e.exports="0.1.28"},896:e=>{"use strict";e.exports=require("fs")},278:e=>{"use strict";e.exports=require("net")},857:e=>{"use strict";e.exports=require("os")},756:e=>{"use strict";e.exports=require("tls")},733:t=>{"use strict";t.exports=e},111:e=>{"use strict";e.exports=t},766:e=>{"use strict";e.exports=s},429:e=>{"use strict";e.exports=n},688:e=>{"use strict";e.exports=i}},o={},function e(t){var s=o[t];if(void 0!==s)return s.exports;var n=o[t]={exports:{}};return r[t](n,n.exports,e),n.exports}(237);var r,o}));